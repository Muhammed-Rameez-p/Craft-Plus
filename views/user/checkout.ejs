<%- include('../user/partials/head.ejs') %>

<%- include('../user/partials/navigation.ejs') %>

<!-- <section class="breadcrumb breadcrumb_bg">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div class="breadcrumb_iner">
          <div class="breadcrumb_iner_item">
            <h2>Product Checkout</h2>
            <p>Home <span>-</span> Shop Single</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</section> -->

<div class="mt-5" >
   <div class="pt-5">

   </div>
</div>
<!--================Checkout Area =================-->
<section class="checkout_area padding_top" style="padding: 0">
  <div class="container">
    <div class="returning_customer">
      <div class="billing_details">
        <div class="row">
          <div class="col-lg-8">
            <% if(address.length !=0){%>
            <div class="m-4 row mb-4 border">
              <div class="col-4 mt-3">
                <h5>Delivery Address</h5>
              </div>
              <div class="col-6">
                <p><%= address[index].fullName %></p>
                <p><%= address[index].Phone %></p>
                <p><%= address[index].pincode %></p>
                <p><%= address[index].addressLine %></p>
                <p><%= address[index].landMark %></p>
                <p><%= address[index].city %></p>
                <p><%= address[index].state %></p>
              </div>
              <div class="col-2 mt-3">
                <a onclick="showAllAddress()" href="#">Change</a>
              </div>
            </div>
            <%} %>
            <div id="allAddress" style="display: none" class="p-3 mt-4 mb-4">
              <form action="/Addcheckout" method="post">
                <% address.forEach((addresses,index)=>{ %>
                <div class="mt-4 p-4 border form-check">
                  <input
                    class="form-check-input"
                    type="radio"
                    value="<%= index %> "
                    name="index"
                    id="flexRadioDefault1"
                  />
                  <label for="">
                    <%=addresses.fullName %> <%=addresses.phone %> <br />
                    <%=addresses.addressLine %> , <%=addresses.landMark %> ,
                    <%=addresses.city %>, <%=addresses.state %> ,
                    <%=addresses.pincode %>
                  </label>
                </div>
                <% }) %>
                <button type="submit" class="btn btn-primary ms-2 rounded mt-3">
                  Delivery here
                </button>
              </form>
            </div>
            <div class="p-3 mt-4 mb-4 ">
              <a href="#">
                
                <button class="flex-c-m btn_3 stext-101 cl0 size-116 bg3 bor14 hov-btn3 p-lr-15 trans-04 pointer" onclick="showAddressForm()">
                  <i
                    class="fs-16 zmdi zmdi-plus mr-2 "
                    style="font-size: 1rem"
                  ></i
                  >Add New Address
                </button>
              </a>
            </div>
            <div id="addressForm" class="p-5 border" style="display: none">
              <div class="mb-5card-header py-3">
                <h5 class="mtext-101 mb-0">Address details</h5>
              </div>
              <form action="/addnewaddress" class="mb-0" method="post">
                <div class="row mb-4">
                  <div class="col">
                    <div class="form-outline">
                      <input
                        type="text"
                        id="form9Example1"
                        name="fullName"
                        class="form-control input-custom"
                      />
                      <label class="form-label" for="form9Example1"
                        >Full name</label
                      >
                    </div>
                  </div>
                  <div class="col">
                    <div class="form-outline">
                      <input
                        type="text"
                        id="form9Example2"
                        name="houseName"
                        class="form-control input-custom"
                      />
                      <label class="form-label" for="form9Example2"
                        >House name / Office name</label
                      >
                    </div>
                  </div>
                </div>
                <div class="row mb-4">
                  <div class="col">
                    <div class="form-outline">
                      <input
                        type="text"
                        id="form9Example3"
                        name="city"
                        class="form-control input-custom"
                      />
                      <label class="form-label" for="form9Example3">City</label>
                    </div>
                  </div>
                  <div class="col">
                    <div class="form-outline">
                      <input
                        type="text"
                        id="form9Example4"
                        name="state"
                        class="form-control input-custom"
                      />
                      <label class="form-label" for="form9Example4"
                        >State</label
                      >
                    </div>
                  </div>
                </div>
                <div class="row mb-4">
                  <div class="col">
                    <div class="form-outline">
                      <input
                        type="number"
                        id="form9Example6"
                        name="pincode"
                        class="form-control input-custom"
                      />
                      <label class="form-label" for="form9Example6"
                        >Pincode</label
                      >
                    </div>
                  </div>
                  <div class="col">
                    <div class="form-outline">
                      <input
                        type="number"
                        id="typeEmail"
                        name="phone"
                        class="form-control input-custom"
                      />
                      <label class="form-label" for="typeEmail">Phone</label>
                    </div>
                  </div>
                </div>
                <div class="float-end">
                  <button
                    type="submit"
                    class="btn btn-primary btn-rounded"
                    style="background-color: #0062cc"
                  >
                    add address
                  </button>
                </div>
              </form>
            </div>
          </div>
          <div class="col-lg-4">
            <br />
            <div class="order_box" style="margin-top: 1.5">
              <h2>Your Order</h2>
              <ul class="list list_2">
                <li>
                  <a href="#"
                    >Shipping
                    <span>Free</span>
                  </a>
                </li>
                <li>
                  <a href="#"
                    >Total
                    <span> <%= cartItems.cart.totalPrice %> </span>
                  </a>
                </li>
              </ul>
              <div class="payment_item">
                <div class="mt-4 form-check">
                  <input
                    class="form-check-input"
                    type="radio"
                    value="cod"
                    name="payment"
                    id="cod"
                    checked
                  />
                  <label class="form-check-label" for="flexRadioDefault1">
                    Cash on Delivery
                  </label>
                </div>
                <div class="form-check mb-5">
                  <input
                    class="form-check-input"
                    type="radio"
                    value="Razorpay"
                    name="payment"
                    id="flexRadioDefault2"
                  />
                  <label class="form-check-label" for="flexRadioDefault2">
                    Razorpay
                  </label>
                </div>
              </div>
              <hr />
              <button
                type="submit"
                onclick="placeOrder('<%= index %>')"
                class="flex-c-m btn_3 stext-101 cl0 size-116 bg3 bor14 hov-btn3 p-lr-15 trans-04 pointer"
              >
                PAY NOW
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      function showAllAddress() {
        const address = document.getElementById("allAddress");
        if (address.style.display == "none") {
          address.style.display = "block";
        } else {
          address.style.display = "none";
        }
      }
    </script>
    <script>
      function showAddressForm() {
        const address = document.getElementById("addressForm");
        if (address.style.display == "none") {
          address.style.display = "block";
        } else {
          address.style.display = "none";
        }
      }
    </script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script>
      function placeOrder(indexof) {
        let index = indexof;
        let paymentMethod = document.querySelector("#cod").checked
          ? "COD"
          : "Razorpay";
        // sweet alrt
        Swal.fire({
          title: "Are you sure?",
          text: "You won't be able to revert this!",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#3085d6",
          cancelButtonColor: "#d33",
          confirmButtonText: "Yes, Place Order!",
        }).then((result) => {
          if (result.isConfirmed) {
            Swal.fire(
              "Order placed!",
              "",
              "success"
            );
            axios
              .get(
                `/payment-verify?index=${index}&paymentMethod=${paymentMethod}`
              )
              .then((response) => {
                if (response.data.payment) {
                  location.assign("/order-success");
                } else {
                  razorpayPayment(response);
                }
              });
          }
        });
      
      }

function razorpayPayment(order) {
  console.log('nan vannu');
  var options = {
    key: 'rzp_test_o36HFRe8uwODAt',
    amount: order.data.amount,
    currency: "INR",
    name: "SofaWorld",
    description: "Test Transaction",
    image: "https://example.com/your_logo",
    order_id: order.data.id,
    
    prefill: {
      name: "Gaurav Kumar",
      email: "gaurav.kumar@example.com",
      contact: "9999999999",
    },
    
    handler: function (response) {
  
verifyPayment(response, order)
     
    },
    notes: {
      address: "Razorpay Corporate Office",
    },
    theme: {
      color: "#3399cc",
    },
  };

  var rzp1 = new Razorpay(options);
  rzp1.open();

  function verifyPayment(payment, order) {
  
  console.log(payment,'hiiiii');
  console.log('enteringg.........................');
    axios   
      .post("/verify", { payment, order })
      .then((response) => {
        if(response.data.paymentSuccess){
          location.assign("/order-success");
        }
       
      });
  }
 
}

    </script>

<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!--================End Checkout Area =================-->
    <%- include('../user/partials/end.ejs') %>
  </div>
</section>

